poliza_actual_cuadro = [
    {"Interés Asegurado": "Edificios", "Valor Asegurado": 22615066519},
    {"Interés Asegurado": "Equipo Electrónico", "Valor Asegurado": 1204502680},
    {"Interés Asegurado": "Muebles y Enseres", "Valor Asegurado": 1621213188},
    {"Interés Asegurado": "Maquinaria y Equipo", "Valor Asegurado": 2928485866},
    {"Interés Asegurado": "Mercancías", "Valor Asegurado": 46200000},
    {"Interés Asegurado": "Dinero", "Valor Asegurado": 196000000},
    {"Interés Asegurado": "Eq. Móviles y Portátiles", "Valor Asegurado": 82695800},
]

poliza_renovacion_cuadro = [
    {"Interés Asegurado": "Edificios", "Valor Asegurado": 24876573170},
    {"Interés Asegurado": "Equipo Electrónico", "Valor Asegurado": 1245453104},
    {"Interés Asegurado": "Muebles y Enseres", "Valor Asegurado": 1783334507},
    {"Interés Asegurado": "Maquinaria y Equipo", "Valor Asegurado": 3221334452},
    {"Interés Asegurado": "Mercancías", "Valor Asegurado": 46200000},
    {"Interés Asegurado": "Dinero", "Valor Asegurado": 196000000},
    {"Interés Asegurado": "Eq. Móviles y Portátiles", "Valor Asegurado": 94156337},
]

docs_adicionales_data = [
    {
        "Archivo": "Slip Cotización 2500004260 Pyme Segura 10+ (1).pdf",
        "Prima Sin IVA": 6093640,
        "IVA": 1157792,
        "Prima Con IVA": 7251432,
    },
    {
        "Archivo": "SLIP TRDM OFICINAS_CAMARA DE COMERCIO.pdf",
        "Prima Sin IVA": 28289403,
        "IVA": 0,
        "Prima Con IVA": 28289403,
    },
]

riesgos = [
    {
        "ubicacion": "Calle 28 # 30-15 PALMIRA",
        "detalle_cobertura": [
            {
                "interes_asegurado": "Edificio",
                "valor_asegurado": 3061592832,
                "tipo": "Incendio",
            },
            {
                "interes_asegurado": "Maquinaria y Equipo",
                "valor_asegurado": 141240000,
                "tipo": "Equipo y Maquinaria",
            },
            {
                "interes_asegurado": "Equipo Eléctrico y Electrónico",
                "valor_asegurado": 58850000,
                "tipo": "Equipo y Maquinaria",
            },
        ],
    },
    {
        "ubicacion": "Carrera 18 #8-31 FLORIDA",
        "detalle_cobertura": [
            {
                "interes_asegurado": "Edificio",
                "valor_asegurado": 505019752,
                "tipo": "Incendio",
            },
            {
                "interes_asegurado": "Muebles y Enseres",
                "valor_asegurado": 100145560,
                "tipo": "Incendio",
            },
            {
                "interes_asegurado": "Maquinaria y Equipo",
                "valor_asegurado": 77255146,
                "tipo": "Equipo y Maquinaria",
            },
            {
                "interes_asegurado": "Equipo Eléctrico y Electrónico",
                "valor_asegurado": 59352677,
                "tipo": "Equipo y Maquinaria",
            },
            {
                "interes_asegurado": "Mercancías",
                "valor_asegurado": 11000000,
                "tipo": "Incendio",
            },
            {
                "interes_asegurado": "Dineros",
                "valor_asegurado": 22000000,
                "tipo": "Manejo de Dinero",
            },
        ],
    },
    {
        "ubicacion": "Calle 6 # 12-50 PRADERA",
        "detalle_cobertura": [
            {
                "interes_asegurado": "Edificio",
                "valor_asegurado": 586566851,
                "tipo": "Incendio",
            },
            {
                "interes_asegurado": "Muebles y Enseres",
                "valor_asegurado": 123035974,
                "tipo": "Incendio",
            },
            {
                "interes_asegurado": "Maquinaria y Equipo",
                "valor_asegurado": 77255146,
                "tipo": "Equipo y Maquinaria",
            },
            {
                "interes_asegurado": "Equipo Eléctrico y Electrónico",
                "valor_asegurado": 55386331,
                "tipo": "Equipo y Maquinaria",
            },
            {
                "interes_asegurado": "Mercancías",
                "valor_asegurado": 11000000,
                "tipo": "Incendio",
            },
            {
                "interes_asegurado": "Dineros",
                "valor_asegurado": 22000000,
                "tipo": "Manejo de Dinero",
            },
        ],
    },
    {
        "ubicacion": "Carrera 7 #. 11-56 CANDELARIA",
        "detalle_cobertura": [
            {
                "interes_asegurado": "Edificio",
                "valor_asegurado": 806887083,
                "tipo": "Incendio",
            },
            {
                "interes_asegurado": "Muebles y Enseres",
                "valor_asegurado": 91561655,
                "tipo": "Incendio",
            },
            {
                "interes_asegurado": "Maquinaria y Equipo",
                "valor_asegurado": 38627573,
                "tipo": "Equipo y Maquinaria",
            },
            {
                "interes_asegurado": "Equipo Eléctrico y Electrónico",
                "valor_asegurado": 46705241,
                "tipo": "Equipo y Maquinaria",
            },
            {
                "interes_asegurado": "Mercancías",
                "valor_asegurado": 2200000,
                "tipo": "Incendio",
            },
            {
                "interes_asegurado": "Dineros",
                "valor_asegurado": 22000000,
                "tipo": "Manejo de Dinero",
            },
        ],
    },
    {
        "ubicacion": "Carrera 31 # 28-00 y Calle 28 #31-30 Esq PALMIRA",
        "detalle_cobertura": [
            {
                "interes_asegurado": "Edificio",
                "valor_asegurado": 17655000000,
                "tipo": "Incendio",
            },
            {
                "interes_asegurado": "Muebles y Enseres",
                "valor_asegurado": 921591000,
                "tipo": "Incendio",
            },
            {
                "interes_asegurado": "Obras de Arte",
                "valor_asegurado": 384879000,
                "tipo": "Incendio",
            },
            {
                "interes_asegurado": "Maquinaria y Equipo",
                "valor_asegurado": 2594108000,
                "tipo": "Equipo y Maquinaria",
            },
            {
                "interes_asegurado": "Equipo Eléctrico y Electrónico",
                "valor_asegurado": 977178797,
                "tipo": "Equipo y Maquinaria",
            },
            {
                "interes_asegurado": "Equipo Móvil",
                "valor_asegurado": 73562500,
                "tipo": "Equipo y Maquinaria",
            },
            {
                "interes_asegurado": "Mercancías",
                "valor_asegurado": 22000000,
                "tipo": "Incendio",
            },
            {
                "interes_asegurado": "Dineros",
                "valor_asegurado": 130000000,
                "tipo": "Manejo de Dinero",
            },
        ],
    },
]


def generar_excel_analisis_polizas(output_path="analisis_polizas.xlsx"):
    """
    Genera un archivo Excel con análisis de pólizas replicando la funcionalidad
    del código original de app_structure.py usando los datos de x.py

    Args:
        output_path (str): Ruta donde se guardará el archivo Excel

    Returns:
        str: Ruta del archivo generado
    """
    import pandas as pd
    from io import BytesIO
    from openpyxl.styles import Font, PatternFill, Border, Side, Alignment
    from openpyxl.utils import get_column_letter

    output = BytesIO()

    with pd.ExcelWriter(output, engine="openpyxl") as writer:
        # ===== estilos =====
        header_font = Font(name="Calibri", size=12, bold=True, color="FFFFFF")
        header_fill = PatternFill(
            start_color="2E75B6", end_color="2E75B6", fill_type="solid"
        )
        data_font = Font(name="Calibri", size=11)
        border = Border(
            left=Side(style="thin", color="D0D0D0"),
            right=Side(style="thin", color="D0D0D0"),
            top=Side(style="thin", color="D0D0D0"),
            bottom=Side(style="thin", color="D0D0D0"),
        )
        center_alignment = Alignment(horizontal="center", vertical="center")
        currency_alignment = Alignment(horizontal="right", vertical="center")
        left_alignment = Alignment(horizontal="left", vertical="center")

        def format_worksheet(ws, df, sheet_type):
            ws.insert_rows(1, 2)
            title_cell = ws.cell(row=1, column=1)
            title_cell.value = "CENTRO DE DIAGNOSTICO AUTOMOTOR DE PALMIRA"
            title_cell.font = Font(name="Arial", size=16, bold=True, color="FFFFFF")
            title_cell.fill = PatternFill(
                start_color="1F4E79", end_color="1F4E79", fill_type="solid"
            )
            title_cell.alignment = Alignment(horizontal="center", vertical="center")
            ws.merge_cells(
                start_row=1, start_column=1, end_row=1, end_column=len(df.columns)
            )

            if sheet_type == "polizas":
                label_font = Font(name="Arial", size=14, bold=True, color="FFFFFF")
                label_fill = PatternFill(
                    start_color="4472C4", end_color="4472C4", fill_type="solid"
                )
                for row_num in range(3, ws.max_row + 1):
                    cell_value = ws.cell(row=row_num, column=1).value
                    if cell_value and (
                        "PÓLIZAS ACTUALES" in str(cell_value)
                        or "PÓLIZAS DE RENOVACIÓN" in str(cell_value)
                    ):
                        label_cell = ws.cell(row=row_num, column=1)
                        label_cell.font = label_font
                        label_cell.fill = label_fill
                        label_cell.alignment = Alignment(
                            horizontal="center", vertical="center"
                        )
                        ws.merge_cells(
                            start_row=row_num,
                            start_column=1,
                            end_row=row_num,
                            end_column=len(df.columns),
                        )

            for col_num in range(1, len(df.columns) + 1):
                cell = ws.cell(row=3, column=col_num)
                cell.font = header_font
                cell.fill = header_fill
                cell.border = border
                cell.alignment = center_alignment

            for row_num in range(4, len(df) + 4):
                for col_num in range(1, len(df.columns) + 1):
                    cell = ws.cell(row=row_num, column=col_num)
                    cell.font = data_font
                    cell.border = border
                    col_name = df.columns[col_num - 1]
                    if any(x in col_name.lower() for x in ["valor", "prima", "iva"]):
                        cell.alignment = currency_alignment
                        if isinstance(cell.value, (int, float)):
                            cell.number_format = "$#,##0"
                    elif col_name.lower() == "coberturas":
                        cell.alignment = left_alignment
                    else:
                        cell.alignment = center_alignment

            for col_num in range(1, len(df.columns) + 1):
                column_letter = get_column_letter(col_num)
                col_name = df.columns[col_num - 1]
                max_length = max(
                    len(str(col_name)),
                    len("CENTRO DE DIAGNOSTICO AUTOMOTOR DE PALMIRA")
                    // len(df.columns),
                )
                for row_num in range(4, len(df) + 4):
                    cell_value = str(ws.cell(row=row_num, column=col_num).value or "")
                    max_length = max(max_length, len(cell_value))
                if col_name.lower() == "coberturas":
                    width = 45
                else:
                    width = min(max(max_length + 2, 15), 30)
                ws.column_dimensions[column_letter].width = width

            ws.auto_filter.ref = f"A1:{get_column_letter(len(df.columns))}{len(df) + 1}"
            ws.freeze_panes = "A2"

        # ===== hoja Análisis_Estructurado =====
        intereses_unicos = list(
            set(
                [item["Interés Asegurado"] for item in poliza_actual_cuadro]
                + [item["Interés Asegurado"] for item in poliza_renovacion_cuadro]
            )
        )
        valores_actuales = {
            item["Interés Asegurado"]: item["Valor Asegurado"]
            for item in poliza_actual_cuadro
        }
        valores_renovacion = {
            item["Interés Asegurado"]: item["Valor Asegurado"]
            for item in poliza_renovacion_cuadro
        }
        total_actual = sum(valores_actuales.values())
        total_renovacion = sum(valores_renovacion.values())

        coberturas = [
            "Incendio y/o Rayo Edificios",
            "Explosión Mejoras Locativas",
            "Terremoto, temblor Muebles y Enseres",
            "Asonada, motin, conm. Civil/popular huelga Mercancias Fijas",
            "Extension de amparo",
            "Daños por agua, Anegación Dineros",
            "Incendio y/o Rayo en aparatos electricos Equipo Electronico",
        ]

        columnas_analisis = [
            "Coberturas",
            "Interés Asegurado",
            "Valor Asegurado Actual",
            "Valor Asegurado Renovado",
        ]
        intereses_ordenados = sorted(intereses_unicos)
        max_filas = max(len(intereses_ordenados), len(coberturas))

        datos_estructurados = []
        for i in range(max_filas):
            fila = {
                "Coberturas": coberturas[i] if i < len(coberturas) else "",
                "Interés Asegurado": (
                    intereses_ordenados[i] if i < len(intereses_ordenados) else ""
                ),
                "Valor Asegurado Actual": (
                    valores_actuales.get(intereses_ordenados[i], 0)
                    if i < len(intereses_ordenados)
                    else ""
                ),
                "Valor Asegurado Renovado": (
                    valores_renovacion.get(intereses_ordenados[i], 0)
                    if i < len(intereses_ordenados)
                    else ""
                ),
            }
            datos_estructurados.append(fila)

        datos_estructurados.append(
            {
                "Coberturas": "",
                "Interés Asegurado": "TOTAL",
                "Valor Asegurado Actual": total_actual,
                "Valor Asegurado Renovado": total_renovacion,
            }
        )

        # forzar solo columnas definidas
        df_estructurado = pd.DataFrame(datos_estructurados)[columnas_analisis]

        df_estructurado.to_excel(
            writer, sheet_name="Análisis_Estructurado", index=False
        )
        format_worksheet(
            writer.sheets["Análisis_Estructurado"], df_estructurado, "polizas"
        )

        # ===== hoja Polizas_Consolidadas =====
        def crear_hoja_consolidada():
            def procesar_poliza(poliza_data):
                if not poliza_data:
                    return None, None
                intereses_valores = {}
                total_poliza = sum(item["Valor Asegurado"] for item in poliza_data)
                for item in poliza_data:
                    intereses_valores[item["Interés Asegurado"]] = item[
                        "Valor Asegurado"
                    ]
                columnas = list(intereses_valores.keys()) + ["Total Póliza"]
                valores = [f"${valor:,.0f}" for valor in intereses_valores.values()] + [
                    f"${total_poliza:,.0f}"
                ]
                return columnas, valores

            columnas_actuales, valores_actuales = procesar_poliza(poliza_actual_cuadro)
            columnas_renovacion, valores_renovacion = procesar_poliza(
                poliza_renovacion_cuadro
            )

            datos_consolidados = []
            if columnas_actuales and valores_actuales:
                datos_consolidados.append(
                    ["PÓLIZAS ACTUALES"] + [""] * (len(columnas_actuales) - 1)
                )
                datos_consolidados.append(columnas_actuales)
                datos_consolidados.append(valores_actuales)
                datos_consolidados.append([""] * len(columnas_actuales))

            if columnas_renovacion and valores_renovacion:
                max_cols = max(
                    (len(columnas_actuales) if columnas_actuales else 0),
                    len(columnas_renovacion),
                )
                datos_consolidados.append(
                    ["PÓLIZAS DE RENOVACIÓN"] + [""] * (max_cols - 1)
                )
                columnas_renovacion_ajustadas = columnas_renovacion + [""] * (
                    max_cols - len(columnas_renovacion)
                )
                valores_renovacion_ajustados = valores_renovacion + [""] * (
                    max_cols - len(valores_renovacion)
                )
                datos_consolidados.append(columnas_renovacion_ajustadas)
                datos_consolidados.append(valores_renovacion_ajustados)

            if datos_consolidados:
                max_cols = max(len(fila) for fila in datos_consolidados)
                for i, fila in enumerate(datos_consolidados):
                    if len(fila) < max_cols:
                        datos_consolidados[i] = fila + [""] * (max_cols - len(fila))
                columnas_genericas = [f"Columna_{i+1}" for i in range(max_cols)]
                df_consolidado = pd.DataFrame(
                    datos_consolidados, columns=columnas_genericas
                )
                df_consolidado.to_excel(
                    writer, sheet_name="Polizas_Consolidadas", index=False, header=False
                )
                format_worksheet(
                    writer.sheets["Polizas_Consolidadas"], df_consolidado, "polizas"
                )

        crear_hoja_consolidada()

    with open(output_path, "wb") as f:
        f.write(output.getvalue())

    print(f"✅ Archivo Excel generado exitosamente: {output_path}")
    return output_path


if __name__ == "__main__":

    generar_excel_analisis_polizas()
