# poliza_actual_cuadro
poliza_actual = [
    {"Interés Asegurado": "Edificios", "Valor Asegurado": 22615066519},
    {"Interés Asegurado": "Equipo Electrónico", "Valor Asegurado": 1204502680},
    {"Interés Asegurado": "Muebles y Enseres", "Valor Asegurado": 1621213188},
    {"Interés Asegurado": "Maquinaria y Equipo", "Valor Asegurado": 2928485866},
    {"Interés Asegurado": "Mercancías", "Valor Asegurado": 46200000},
    {"Interés Asegurado": "Dinero", "Valor Asegurado": 196000000},
    {"Interés Asegurado": "Eq. Móviles y Portátiles", "Valor Asegurado": 82695800},
]
# poliza_renovacion_cuadro
poliza_renovacion = [
    {"Interés Asegurado": "Edificios", "Valor Asegurado": 24876573170},
    {"Interés Asegurado": "Equipo Electrónico", "Valor Asegurado": 1245453104},
    {"Interés Asegurado": "Muebles y Enseres", "Valor Asegurado": 1783334507},
    {"Interés Asegurado": "Maquinaria y Equipo", "Valor Asegurado": 3221334452},
    {"Interés Asegurado": "Mercancías", "Valor Asegurado": 46200000},
    {"Interés Asegurado": "Dinero", "Valor Asegurado": 196000000},
    {"Interés Asegurado": "Eq. Móviles y Portátiles", "Valor Asegurado": 94156337},
]
# docs_adicionales_data - NO LO USAMOS
docs_adicionales_data = [
    {
        "Archivo": "Slip Cotización 2500004260 Pyme Segura 10+ (1).pdf",
        "Prima Sin IVA": 6093640,
        "IVA": 1157792,
        "Prima Con IVA": 7251432,
    },
    {
        "Archivo": "SLIP TRDM OFICINAS_CAMARA DE COMERCIO.pdf",
        "Prima Sin IVA": 28289403,
        "IVA": 0,
        "Prima Con IVA": 28289403,
    },
]
# riesgos_actuales
riesgos_actuales = [
    {
        "ubicacion": "CALLE 31 NO. 30 - 09 / 19",
        "detalle_cobertura": [
            {
                "interes_asegurado": "Edificio",
                "valor_asegurado": 7844914000,
                "tipo": ["Incendio"],
            },
            {
                "interes_asegurado": "Muebles y enseres",
                "valor_asegurado": 12511400,
                "tipo": ["Incendio"],
            },
            {
                "interes_asegurado": "Equipo electrónico",
                "valor_asegurado": 83853000,
                "tipo": ["Incendio", "Equipo Electronico"],
            },
            {
                "interes_asegurado": "Maquinaria y equipo",
                "valor_asegurado": 1147854400,
                "tipo": ["Incendio", "Rotura de Maquinaria"],
            },
            {
                "interes_asegurado": "Muebles y enseres",
                "valor_asegurado": 211149840,
                "tipo": ["Sustracción"],
            },
            {
                "interes_asegurado": "Muebles y enseres",
                "valor_asegurado": 83853000,
                "tipo": ["Sustracción"],
            },
            {
                "interes_asegurado": "Responsabilidad Civil Extracontractual",
                "valor_asegurado": 1000000000,
                "tipo": ["Responsabilidad Civil"],
            },
            {
                "interes_asegurado": "Responsabilidad Civil Directores y Administradores",
                "valor_asegurado": 200000000,
                "tipo": ["Responsabilidad Civil"],
            },
            {
                "interes_asegurado": "Manejo de Dinero",
                "valor_asegurado": 5000000,
                "tipo": ["Manejo de Dinero"],
            },
            {
                "interes_asegurado": "Cuotas de Administración",
                "valor_asegurado": 191184840,
                "tipo": ["Incendio"],
            },
        ],
    }
]
# riesgos_renovacion
riesgos_renovacion = [
    {
        "ubicacion": "Calle 28 # 30-15 PALMIRA",
        "detalle_cobertura": [
            {
                "interes_asegurado": "EDIFICIO",
                "valor_asegurado": 3367752116,
                "tipo": ["Incendio"],
            },
            {
                "interes_asegurado": "MAQUINARIA Y EQUIPO",
                "valor_asegurado": 155364000,
                "tipo": ["Equipo y Maquinaria"],
            },
            {
                "interes_asegurado": "EQUIPO ELECTRICO Y ELECTRONICO",
                "valor_asegurado": 64735000,
                "tipo": ["Equipo y Maquinaria"],
            },
        ],
    },
    {
        "ubicacion": "Carrera 18 # 8-31 FLORIDA",
        "detalle_cobertura": [
            {
                "interes_asegurado": "EDIFICIO",
                "valor_asegurado": 555521727,
                "tipo": ["Incendio"],
            },
            {
                "interes_asegurado": "MUEBLES Y ENSERES",
                "valor_asegurado": 110160116,
                "tipo": ["Incendio"],
            },
            {
                "interes_asegurado": "MAQUINARIA Y EQUIPO",
                "valor_asegurado": 84980661,
                "tipo": ["Equipo y Maquinaria"],
            },
            {
                "interes_asegurado": "EQUIPO ELECTRICO Y ELECTRONICO",
                "valor_asegurado": 69072144,
                "tipo": ["Equipo y Maquinaria"],
            },
            {
                "interes_asegurado": "MERCANCIAS",
                "valor_asegurado": 11000000,
                "tipo": ["Incendio", "Sustracción"],
            },
            {
                "interes_asegurado": "DINEROS",
                "valor_asegurado": 22000000,
                "tipo": ["Manejo de Dinero", "Sustracción", "Transporte de Valores"],
            },
        ],
    },
    {
        "ubicacion": "Calle 6 # 12-50 PRADERA",
        "detalle_cobertura": [
            {
                "interes_asegurado": "EDIFICIO",
                "valor_asegurado": 645223536,
                "tipo": ["Incendio"],
            },
            {
                "interes_asegurado": "MUEBLES Y ENSERES",
                "valor_asegurado": 135339571,
                "tipo": ["Incendio"],
            },
            {
                "interes_asegurado": "MAQUINARIA Y EQUIPO",
                "valor_asegurado": 84980661,
                "tipo": ["Equipo y Maquinaria"],
            },
            {
                "interes_asegurado": "EQUIPO ELECTRICO Y ELECTRONICO",
                "valor_asegurado": 64709165,
                "tipo": ["Equipo y Maquinaria"],
            },
            {
                "interes_asegurado": "MERCANCIAS",
                "valor_asegurado": 11000000,
                "tipo": ["Incendio", "Sustracción"],
            },
            {
                "interes_asegurado": "DINEROS",
                "valor_asegurado": 22000000,
                "tipo": ["Manejo de Dinero", "Sustracción", "Transporte de Valores"],
            },
        ],
    },
    {
        "ubicacion": "Carrera 7 #. 11-56 CANDELARIA",
        "detalle_cobertura": [
            {
                "interes_asegurado": "EDIFICIO",
                "valor_asegurado": 887575791,
                "tipo": ["Incendio"],
            },
            {
                "interes_asegurado": "MUEBLES Y ENSERES",
                "valor_asegurado": 100717820,
                "tipo": ["Incendio"],
            },
            {
                "interes_asegurado": "MAQUINARIA Y EQUIPO",
                "valor_asegurado": 42490330,
                "tipo": ["Equipo y Maquinaria"],
            },
            {
                "interes_asegurado": "EQUIPO ELECTRICO Y ELECTRONICO",
                "valor_asegurado": 55159965,
                "tipo": ["Equipo y Maquinaria"],
            },
            {
                "interes_asegurado": "MERCANCIAS",
                "valor_asegurado": 2200000,
                "tipo": ["Incendio", "Sustracción"],
            },
            {
                "interes_asegurado": "DINEROS",
                "valor_asegurado": 22000000,
                "tipo": ["Manejo de Dinero", "Sustracción", "Transporte de Valores"],
            },
        ],
    },
    {
        "ubicacion": "Carrera 31 # 28-00 y Calle 28 #31-30 Esq PALMIRA",
        "detalle_cobertura": [
            {
                "interes_asegurado": "EDIFICIO",
                "valor_asegurado": 19420500000,
                "tipo": ["Incendio"],
            },
            {
                "interes_asegurado": "MUEBLES Y ENSERES Y OBRAS DE ARTE",
                "valor_asegurado": 1437117000,
                "tipo": ["Incendio"],
            },
            {
                "interes_asegurado": "MAQUINARIA Y EQUIPO",
                "valor_asegurado": 2853518800,
                "tipo": ["Equipo y Maquinaria"],
            },
            {
                "interes_asegurado": "EQUIPO ELECTRICO Y ELECTRONICO",
                "valor_asegurado": 991776830,
                "tipo": ["Equipo y Maquinaria"],
            },
            {
                "interes_asegurado": "EQUIPO MOVIL",
                "valor_asegurado": 94156337,
                "tipo": ["Equipo y Maquinaria"],
            },
            {
                "interes_asegurado": "MERCANCIAS",
                "valor_asegurado": 22000000,
                "tipo": ["Incendio", "Sustracción"],
            },
            {
                "interes_asegurado": "DINEROS",
                "valor_asegurado": 130000000,
                "tipo": ["Manejo de Dinero", "Sustracción", "Transporte de Valores"],
            },
        ],
    },
]
# amparos_actuales
amparos_actuales = {
    "archivo": "POLIZA ACTUAL EMPRESARIAL 128663630-0 CAMARA DE COMERCIO DE PALMIRA 2024-2025.pdf",
    "amparos": [
        {
            "amparo": "Incendio y/o Impacto Directo De Rayo",
            "deducible": "5% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "Explosión",
            "deducible": "5% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "Extensión de Amparos",
            "deducible": "5% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "Explosión de Calderas u Otros Aparatos Generadores de Vapor",
            "deducible": "5% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Incendio", "Equipo y Maquinaria"],
        },
        {
            "amparo": "Rotura Accidental De Vidrios",
            "deducible": "0,25 SMMLV",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "Terremoto, Temblor De Tierra, Erupción Volcánica, Tsunami, Maremoto",
            "deducible": "2% del valor asegurable del artículo mínimo 1 SMMLV",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "Anegación",
            "deducible": "5% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "Daños Por Agua",
            "deducible": "5% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "AMIT Y Terrorismo",
            "deducible": "5% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "HMACC",
            "deducible": "5% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "Productos Almacenados En Frigoríficos",
            "deducible": "10% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "Daño Interno Equipos Eléctricos Y Electrónicos",
            "deducible": "10% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Equipo y Maquinaria"],
        },
        {
            "amparo": "Portadores Externos de Datos",
            "deducible": "10% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Equipo y Maquinaria"],
        },
        {
            "amparo": "Equipos Móviles Y Portátiles",
            "deducible": "10% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Equipo y Maquinaria", "Sustracción"],
        },
        {
            "amparo": "Incremento en Costos De Operación",
            "deducible": "10% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "Daños por Fallas En Equipos De Climatización",
            "deducible": "10% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Equipo y Maquinaria"],
        },
        {
            "amparo": "Rotura De Maquinaria",
            "deducible": "10% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Equipo y Maquinaria"],
        },
        {
            "amparo": "Pérdida de Contenido en Tanques",
            "deducible": "10% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "Deterioro de Bienes Refrigerados",
            "deducible": "10% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "Hurto Calificado",
            "deducible": "10% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Sustracción"],
        },
        {
            "amparo": "Hurto Simple para Equipo Eléctrico Y Electrónico Fijo de Oficina",
            "deducible": "10% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Sustracción", "Equipo y Maquinaria"],
        },
        {
            "amparo": "Bienes de Propiedad de Empleados del Asegurado",
            "deducible": "5% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Sustracción"],
        },
        {
            "amparo": "Traslado Temporal de Bienes",
            "deducible": "5% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Sustracción"],
        },
        {
            "amparo": "Construcciones y Montajes Nuevos",
            "deducible": "5% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "Bienes a la Intemperie",
            "deducible": "5% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "Actos de Autoridad",
            "deducible": "5% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "Remoción de Escombros",
            "deducible": "Aplica el de la cobertura afectada",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "Honorarios de Profesionales como Arquitectos, Interventores, Ingenieros y Consultores",
            "deducible": "Aplica el de la cobertura afectada",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "Gastos para la Preservación de Bienes",
            "deducible": "Aplica el de la cobertura afectada",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "Gastos para la Reproducción y/o Reemplazo de la Información",
            "deducible": "Aplica el de la cobertura afectada",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "Gastos para Demostrar la Pérdida",
            "deducible": "Aplica el de la cobertura afectada",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "Transporte De Valores",
            "deducible": "5% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Transporte de Valores"],
        },
        {
            "amparo": "Gastos de Extinción del siniestro",
            "deducible": "Aplica el de la cobertura afectada",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "Daños o pérdidas de Mercancías a Granel",
            "deducible": "5% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "Manejo",
            "deducible": "10% del valor de la pérdida mínimo 2 SMMLV",
            "tipo": ["Manejo de Dinero", "Sustracción"],
        },
        {
            "amparo": "Empleados de Carácter Temporal y/o de Firmas Especializadas",
            "deducible": "10% del valor de la pérdida mínimo 2 SMMLV",
            "tipo": ["Manejo de Dinero", "Sustracción"],
        },
        {
            "amparo": "Empleados no Identificados",
            "deducible": "10% del valor de la pérdida mínimo 2 SMMLV",
            "tipo": ["Manejo de Dinero", "Sustracción"],
        },
        {
            "amparo": "Bienes de Propiedad de Terceros",
            "deducible": "10% del valor de la pérdida mínimo 2 SMMLV",
            "tipo": ["Manejo de Dinero", "Sustracción"],
        },
        {
            "amparo": "Protección para Depósitos Bancarios",
            "deducible": "10% del valor de la pérdida mínimo 2 SMMLV",
            "tipo": ["Manejo de Dinero", "Sustracción"],
        },
        {
            "amparo": "Predios Labores y Operaciones",
            "deducible": "10% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Responsabilidad Civil"],
        },
        {
            "amparo": "Contratistas y Subcontratistas",
            "deducible": "10% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Responsabilidad Civil"],
        },
        {
            "amparo": "Responsabilidad Civil Patronal",
            "deducible": "10% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Responsabilidad Civil"],
        },
        {
            "amparo": "Vehículos Propios y no Propios",
            "deducible": "En exceso del SOAT y RCE autos mínimo 100.000.000/100.000.000/200.000.000 COP",
            "tipo": ["Responsabilidad Civil"],
        },
        {
            "amparo": "Propietarios, Arrendatarios y Poseedores",
            "deducible": "10% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Responsabilidad Civil"],
        },
        {
            "amparo": "Gastos Médicos",
            "deducible": "No especificado",
            "tipo": ["Responsabilidad Civil"],
        },
        {
            "amparo": "Responsabilidad Civil Cruzada",
            "deducible": "10% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Responsabilidad Civil"],
        },
        {
            "amparo": "Responsabilidad Civil Parqueaderos",
            "deducible": "10% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Responsabilidad Civil"],
        },
    ],
}
# amparos_renovacion
amparos_renovacion = {
    "archivo": "PR336-186756401-26358662 COT CyC PALMIRA.pdf",
    "amparos": [
        {
            "amparo": "Incendio y/o Impacto Directo De Rayo",
            "deducible": "5% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "Explosión",
            "deducible": "5% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "Extensión de Amparos",
            "deducible": "5% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "Explosión de Calderas u Otros Aparatos Generadores de Vapor",
            "deducible": "5% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "Rotura Accidental De Vidrios",
            "deducible": "0,25 SMMLV",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "Terremoto, Temblor De Tierra, Erupción Volcánica, Tsunami, Maremoto",
            "deducible": "2% del valor asegurable del artículo mínimo 1 SMMLV",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "Anegación",
            "deducible": "5% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "Daños Por Agua",
            "deducible": "5% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "AMIT Y Terrorismo",
            "deducible": "5% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "HMACC",
            "deducible": "5% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "Productos Almacenados En Frigoríficos",
            "deducible": "10% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Incendio", "Equipo y Maquinaria"],
        },
        {
            "amparo": "Daño Interno Equipos Eléctricos Y Electrónicos",
            "deducible": "10% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Equipo y Maquinaria"],
        },
        {
            "amparo": "Portadores Externos de Datos",
            "deducible": "10% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Equipo y Maquinaria"],
        },
        {
            "amparo": "Equipos Móviles Y Portátiles",
            "deducible": "10% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Equipo y Maquinaria"],
        },
        {
            "amparo": "Incremento en Costos De Operación",
            "deducible": "10% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Incendio", "Equipo y Maquinaria"],
        },
        {
            "amparo": "Daños por Fallas En Equipos De Climatización",
            "deducible": "10% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Equipo y Maquinaria"],
        },
        {
            "amparo": "Rotura De Maquinaria",
            "deducible": "10% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Equipo y Maquinaria"],
        },
        {
            "amparo": "Pérdida de Contenido en Tanques",
            "deducible": "10% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "Deterioro de Bienes Refrigerados",
            "deducible": "10% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Incendio", "Equipo y Maquinaria"],
        },
        {
            "amparo": "Hurto Calificado",
            "deducible": "10% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Sustracción"],
        },
        {
            "amparo": "Hurto Simple para Equipo Eléctrico Y Electrónico Fijo de Oficina",
            "deducible": "10% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Sustracción", "Equipo y Maquinaria"],
        },
        {
            "amparo": "Bienes de Propiedad de Empleados del Asegurado",
            "deducible": "5% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Sustracción", "Manejo de Dinero"],
        },
        {
            "amparo": "Traslado Temporal de Bienes",
            "deducible": "5% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Sustracción", "Transporte de Valores"],
        },
        {
            "amparo": "Construcciones y Montajes Nuevos",
            "deducible": "5% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "Bienes a la Intemperie",
            "deducible": "5% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "Actos de Autoridad",
            "deducible": "5% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "Remoción de Escombros",
            "deducible": "Aplica el de la cobertura afectada",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "Honorarios de Profesionales como Arquitectos, Interventores, Ingenieros y Consultores",
            "deducible": "Aplica el de la cobertura afectada",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "Gastos para la Preservación de Bienes",
            "deducible": "Aplica el de la cobertura afectada",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "Gastos para la Reproducción y/o Reemplazo de la Información",
            "deducible": "Aplica el de la cobertura afectada",
            "tipo": ["Incendio", "Equipo y Maquinaria"],
        },
        {
            "amparo": "Gastos para Demostrar la Pérdida",
            "deducible": "Aplica el de la cobertura afectada",
            "tipo": ["Incendio"],
        },
        {
            "amparo": "Transporte De Valores",
            "deducible": "5% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Transporte de Valores"],
        },
        {
            "amparo": "Daños o pérdidas de Mercancías a Granel",
            "deducible": "5% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Incendio", "Sustracción"],
        },
        {
            "amparo": "Manejo",
            "deducible": "10% del valor de la pérdida mínimo 2 SMMLV",
            "tipo": ["Manejo de Dinero"],
        },
        {
            "amparo": "Empleados de Carácter Temporal y/o de Firmas Especializadas",
            "deducible": "10% del valor de la pérdida mínimo 2 SMMLV",
            "tipo": ["Manejo de Dinero"],
        },
        {
            "amparo": "Empleados no Identificados",
            "deducible": "10% del valor de la pérdida mínimo 2 SMMLV",
            "tipo": ["Manejo de Dinero"],
        },
        {
            "amparo": "Bienes de Propiedad de Terceros",
            "deducible": "10% del valor de la pérdida mínimo 2 SMMLV",
            "tipo": ["Manejo de Dinero"],
        },
        {
            "amparo": "Protección para Depósitos Bancarios",
            "deducible": "10% del valor de la pérdida mínimo 2 SMMLV",
            "tipo": ["Manejo de Dinero"],
        },
        {
            "amparo": "Predios Labores y Operaciones",
            "deducible": "10% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Responsabilidad Civil"],
        },
        {
            "amparo": "Contratistas y Subcontratistas",
            "deducible": "10% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Responsabilidad Civil"],
        },
        {
            "amparo": "Responsabilidad Civil Patronal",
            "deducible": "10% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Responsabilidad Civil"],
        },
        {
            "amparo": "Vehículos Propios y no Propios",
            "deducible": "En exceso del SOAT y RCE autos mínimo 100.000.000/100.000.000/200.000.000 COP",
            "tipo": ["Responsabilidad Civil"],
        },
        {
            "amparo": "Propietarios, Arrendatarios y Poseedores",
            "deducible": "10% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Responsabilidad Civil"],
        },
        {
            "amparo": "Responsabilidad Civil Cruzada",
            "deducible": "10% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Responsabilidad Civil"],
        },
        {
            "amparo": "Responsabilidad Civil Parqueaderos",
            "deducible": "10% del valor de la pérdida mínimo 1 SMMLV",
            "tipo": ["Responsabilidad Civil"],
        },
    ],
}
# amparos_adicionales
amparos_adicionales = [
    {
        "archivo": "Slip Cotización 2500004260 Pyme Segura 10+ (1).pdf",
        "amparos": [
            {
                "amparo": "Predios, labores y operaciones",
                "deducible": "$1.000.000",
                "tipo": ["Responsabilidad Civil", "Incendio"],
            },
            {
                "amparo": "Gastos médicos",
                "deducible": "Sin deducible",
                "tipo": ["Responsabilidad Civil"],
            },
            {
                "amparo": "Gastos de defensa",
                "deducible": "Sin deducible",
                "tipo": ["Responsabilidad Civil"],
            },
            {
                "amparo": "Parqueaderos",
                "deducible": "$1.000.000",
                "tipo": ["Responsabilidad Civil"],
            },
            {
                "amparo": "Viajes al exterior",
                "deducible": "$1.000.000",
                "tipo": ["Responsabilidad Civil"],
            },
            {
                "amparo": "Responsabilidad civil patronal por accidentes de trabajo",
                "deducible": "En exceso Seguridad Social",
                "tipo": ["Responsabilidad Civil"],
            },
            {
                "amparo": "Responsabilidad civil por vehículos propios y no propios",
                "deducible": "En exceso de $100.000.000",
                "tipo": ["Responsabilidad Civil"],
            },
            {
                "amparo": "Responsabilidad civil contratistas y subcontratistas independientes (incluye RCE Cruzada)",
                "deducible": "En exceso de $10.000.000",
                "tipo": ["Responsabilidad Civil"],
            },
            {
                "amparo": "Responsabilidad civil por contaminación accidental",
                "deducible": "$1.000.000",
                "tipo": ["Responsabilidad Civil"],
            },
            {
                "amparo": "RCE bienes bajo cuidado, tenencia y control",
                "deducible": "$1.000.000",
                "tipo": ["Responsabilidad Civil"],
            },
            {
                "amparo": "Daño moral, perjuicios fisiológicos, culpa grave y lucro cesante",
                "deducible": "$1.000.000",
                "tipo": ["Responsabilidad Civil"],
            },
            {
                "amparo": "Clientes y empleados del asegurado",
                "deducible": "$1.000.000",
                "tipo": ["Responsabilidad Civil"],
            },
            {
                "amparo": "RCE ensanches, montajes y obras civiles",
                "deducible": "$1.000.000",
                "tipo": ["Responsabilidad Civil"],
            },
            {
                "amparo": "Hurto (Manejo Global Comercial)",
                "deducible": "10% de la pérdida, mínimo 2 SMMLV",
                "tipo": ["Manejo de Dinero", "Sustracción"],
            },
            {
                "amparo": "Hurto calificado (Manejo Global Comercial)",
                "deducible": "10% de la pérdida, mínimo 2 SMMLV",
                "tipo": ["Manejo de Dinero", "Sustracción"],
            },
            {
                "amparo": "Abuso de confianza (Manejo Global Comercial)",
                "deducible": "10% de la pérdida, mínimo 2 SMMLV",
                "tipo": ["Manejo de Dinero", "Sustracción"],
            },
            {
                "amparo": "Falsedad (Manejo Global Comercial)",
                "deducible": "10% de la pérdida, mínimo 2 SMMLV",
                "tipo": ["Manejo de Dinero"],
            },
            {
                "amparo": "Estafa (Manejo Global Comercial)",
                "deducible": "10% de la pérdida, mínimo 2 SMMLV",
                "tipo": ["Manejo de Dinero"],
            },
            {
                "amparo": "Pérdida o daño material durante Transporte de Valores",
                "deducible": "5% de la pérdida, mínimo 1 SMMLV",
                "tipo": ["Transporte de Valores", "Sustracción"],
            },
        ],
    },
    {
        "archivo": "SLIP TRDM OFICINAS_CAMARA DE COMERCIO.pdf",
        "amparos": [
            {
                "amparo": "Incendio y/o rayo o sus efectos inmediatos como calor y humo",
                "deducible": "15% de la pérdida, mínimo 5 SMMLV",
                "tipo": ["Incendio"],
            },
            {
                "amparo": "Explosión",
                "deducible": "15% de la pérdida, mínimo 5 SMMLV",
                "tipo": ["Incendio"],
            },
            {
                "amparo": "Extensión de Amparos (Huracán, tifón, tornado, ciclón, granizo, vientos fuertes, caída de aeronaves, choque de vehículos terrestres)",
                "deducible": "15% de la pérdida, mínimo 5 SMMLV",
                "tipo": ["Incendio"],
            },
            {
                "amparo": "Inundación, anegación, avalancha, enlodamiento y daños por agua",
                "deducible": "15% de la pérdida, mínimo 5 SMMLV",
                "tipo": ["Incendio"],
            },
            {
                "amparo": "Terremoto, temblor, erupción volcánica, maremoto, marejada y/o tsunami",
                "deducible": "2% del valor asegurable del artículo afectado por el siniestro, mínimo 1 SMMLV",
                "tipo": ["Incendio"],
            },
            {
                "amparo": "Huelga, asonada, motín, conmoción civil o popular, actos mal intencionados de terceros, sabotaje y terrorismo",
                "deducible": "10% del valor de la pérdida, mínimo 1 SMMLV",
                "tipo": ["Incendio"],
            },
            {
                "amparo": "Sustracción con violencia (bienes diferentes a equipos eléctricos y electrónicos)",
                "deducible": "10% del valor de la pérdida, mínimo 1 SMMLV",
                "tipo": ["Sustracción"],
            },
            {
                "amparo": "Sustracción con violencia (dineros dentro de caja fuerte)",
                "deducible": "10% del valor de la pérdida mínimo 1 SMMLV",
                "tipo": ["Sustracción", "Manejo de Dinero"],
            },
            {
                "amparo": "Sustracción con violencia (dineros fuera de caja fuerte)",
                "deducible": "10% del valor de la pérdida mínimo 1 SMMLV",
                "tipo": ["Sustracción", "Transporte de Valores"],
            },
            {
                "amparo": "Rotura de maquinaria",
                "deducible": "20% del valor de la pérdida, mínimo 3 SMMLV",
                "tipo": ["Equipo y Maquinaria"],
            },
            {
                "amparo": "Daño interno y hurto calificado (Equipo Eléctrico y Electrónico)",
                "deducible": "Hurto calificado: 10% del valor de la pérdida, mínimo 1 SMMLV; Daño interno: 20% del valor de la pérdida, mínimo 3 SMMLV",
                "tipo": ["Equipo y Maquinaria", "Sustracción"],
            },
            {
                "amparo": "Hurto simple (equipos fijos de oficina)",
                "deducible": "10% del valor de la pérdida, mínimo 1 SMMLV",
                "tipo": ["Equipo y Maquinaria", "Sustracción"],
            },
            {
                "amparo": "Equipos de cómputo móviles y portátiles (excluye hurto simple)",
                "deducible": "10% del valor de la pérdida, mínimo 1 SMMLV (para hurto); 20% del valor de la pérdida, mínimo 3 SMMLV (para daño)",
                "tipo": ["Equipo y Maquinaria"],
            },
            {
                "amparo": "Amparo automático de nuevos bienes o propiedades",
                "deducible": "15% de la pérdida, mínimo 5 SMMLV",
                "tipo": ["Incendio"],
            },
            {
                "amparo": "Remoción de escombros",
                "deducible": "15% de la pérdida, mínimo 5 SMMLV",
                "tipo": ["Incendio"],
            },
            {
                "amparo": "Propiedad personal de empleados",
                "deducible": "15% de la pérdida, mínimo 5 SMMLV",
                "tipo": ["Incendio"],
            },
            {
                "amparo": "Gastos para la extinción del siniestro",
                "deducible": "15% de la pérdida, mínimo 5 SMMLV",
                "tipo": ["Incendio"],
            },
            {
                "amparo": "Gastos para evitar la propagación del siniestro",
                "deducible": "15% de la pérdida, mínimo 5 SMMLV",
                "tipo": ["Incendio"],
            },
            {
                "amparo": "Gastos para la preservación de bienes",
                "deducible": "15% de la pérdida, mínimo 5 SMMLV",
                "tipo": ["Incendio"],
            },
            {
                "amparo": "Gastos para acelerar la reparación o reemplazo",
                "deducible": "15% de la pérdida, mínimo 5 SMMLV",
                "tipo": ["Incendio"],
            },
            {
                "amparo": "Gastos de viaje y estadía",
                "deducible": "15% de la pérdida, mínimo 5 SMMLV",
                "tipo": ["Incendio"],
            },
            {
                "amparo": "Honorarios de auditores, revisores y contadores",
                "deducible": "15% de la pérdida, mínimo 5 SMMLV",
                "tipo": ["Incendio"],
            },
            {
                "amparo": "Gastos por concepto de horas extras, trabajo nocturno, trabajo en días feriados y flete expreso",
                "deducible": "15% de la pérdida, mínimo 5 SMMLV",
                "tipo": ["Incendio"],
            },
            {
                "amparo": "Gastos por reparaciones provisionales o construcciones transitorias y/o temporales",
                "deducible": "15% de la pérdida, mínimo 5 SMMLV",
                "tipo": ["Incendio"],
            },
            {
                "amparo": "Honorarios profesionales",
                "deducible": "15% de la pérdida, mínimo 5 SMMLV",
                "tipo": ["Incendio"],
            },
            {
                "amparo": "Incendio y/o rayo en aparatos eléctricos",
                "deducible": "20% del valor de la pérdida, mínimo 3 SMMLV",
                "tipo": ["Incendio", "Equipo y Maquinaria"],
            },
            {
                "amparo": "Portadores externos de datos",
                "deducible": "20% del valor de la pérdida, mínimo 3 SMMLV",
                "tipo": ["Equipo y Maquinaria"],
            },
            {
                "amparo": "Gastos para la reposición de documentos",
                "deducible": "15% de la pérdida, mínimo 5 SMMLV",
                "tipo": ["Incendio"],
            },
            {
                "amparo": "Rotura accidental de vidrios",
                "deducible": "Sin deducible",
                "tipo": ["Incendio"],
            },
            {
                "amparo": "Traslados temporales de maquinaria y equipos",
                "deducible": "20% del valor de la pérdida, mínimo 3 SMMLV",
                "tipo": ["Equipo y Maquinaria"],
            },
            {
                "amparo": "Nuevas construcciones y montajes menores",
                "deducible": "15% de la pérdida, mínimo 5 SMMLV",
                "tipo": ["Incendio"],
            },
            {
                "amparo": "Amparo automático de ferias y eventos",
                "deducible": "15% de la pérdida, mínimo 5 SMMLV",
                "tipo": ["Incendio"],
            },
            {
                "amparo": "Daños a calderas y/o aparatos generadores de vapor",
                "deducible": "20% del valor de la pérdida, mínimo 3 SMMLV",
                "tipo": ["Equipo y Maquinaria"],
            },
        ],
    },
]

from typing import TypedDict, List


class PolizaDict(TypedDict):
    interes_asegurado: str
    valor_asegurado: int


class DocAdicionalDict(TypedDict):
    archivo: str
    prima_sin_iva: int
    iva: int
    prima_con_iva: int


class DetalleCobertura(TypedDict):
    interes_asegurado: str
    valor_asegurado: int
    tipo: List[str]


class RiesgoDict(TypedDict):
    ubicacion: str
    detalle_cobertura: List[DetalleCobertura]


class Amparo(TypedDict):
    amparo: str
    deducible: str
    tipo: List[str]


class AmparosDict(TypedDict):
    archivo: str
    amparos: List[Amparo]


from typing import List, Optional, TypedDict, Dict, Literal

# Standard library imports
import os
import ssl
from unittest import result
import uuid
import json
import base64
import logging
import shutil
from io import BytesIO
from pathlib import Path
from typing import List, Optional, TypedDict, Dict, Literal
from dataclasses import dataclass, field
from streamlit.runtime.uploaded_file_manager import UploadedFile  # si usas Streamlit
import unicodedata
import re
from copy import deepcopy
from itertools import cycle
import json, pathlib

# Third party imports
import aiohttp
import certifi
import asyncio
import streamlit as st
import pandas as pd
from dotenv import load_dotenv
from openpyxl.styles import Font, Alignment, PatternFill, Border, Side
from openpyxl.utils import get_column_letter
import tempfile


def generar_excel_analisis_polizas(
    riesgos_actuales: List[RiesgoDict],
    riesgos_renovacion: List[RiesgoDict],
    amparos_actuales: AmparosDict,
    amparos_renovacion: AmparosDict,
    amparos_adicionales: List[AmparosDict],
    output_path="reporte_polizas_riesgos.xlsx",
    titulo_excel: Optional[str] = None,
):
    """
    Genera un archivo Excel con análisis de pólizas replicando la funcionalidad
    del código original de app_structure.py usando los datos de x.py

    Args:
        output_path (str): Ruta donde se guardará el archivo Excel

    Returns:
        str: Ruta del archivo generado

    Parámetros adicionales:
        titulo_excel (Optional[str]): Título personalizado que se mostrará en la parte
        superior de cada hoja para diferenciar visualmente el contenido. Si no se
        especifica, se usará un título por defecto acorde a la hoja.
    """

    output = BytesIO()

    with pd.ExcelWriter(output, engine="openpyxl") as writer:
        # ===== estilos =====
        header_font = Font(name="Calibri", size=12, bold=True, color="FFFFFF")
        header_fill = PatternFill(
            start_color="1F4E78", end_color="1F4E78", fill_type="solid"
        )
        data_font = Font(name="Calibri", size=11)
        border = Border(
            left=Side(style="thin", color="000000"),
            right=Side(style="thin", color="000000"),
            top=Side(style="thin", color="000000"),
            bottom=Side(style="thin", color="000000"),
        )
        center_alignment = Alignment(
            horizontal="center", vertical="center", wrap_text=True, shrink_to_fit=True
        )
        currency_alignment = Alignment(
            horizontal="right", vertical="center", wrap_text=True, shrink_to_fit=True
        )
        left_alignment = Alignment(
            horizontal="left", vertical="center", wrap_text=True, shrink_to_fit=True
        )

        # Se omite la creación de las hojas 'Análisis_Estructurado' y 'Polizas_Consolidadas'
        # según requerimiento. El resto del documento permanece intacto.

        # ===== hoja Amparos (tercera hoja) =====
        def crear_hoja_amparos():
            # Generar la tabla unificada de amparos basada en la imagen de referencia
            datos_amparos = []

            # Agregar secciones basadas en tipo de amparo
            tipos_encontrados = set()

            # Procesar amparos actuales
            for amp in amparos_actuales["amparos"]:
                tipos = amp["tipo"] if isinstance(amp["tipo"], list) else [amp["tipo"]]
                for t in tipos:
                    tipos_encontrados.add(t)

            # Procesar amparos renovación
            for amp in amparos_renovacion["amparos"]:
                tipos = amp["tipo"] if isinstance(amp["tipo"], list) else [amp["tipo"]]
                for t in tipos:
                    tipos_encontrados.add(t)

            # Procesar amparos adicionales
            for doc in amparos_adicionales:
                for amp in doc["amparos"]:
                    tipos = (
                        amp["tipo"] if isinstance(amp["tipo"], list) else [amp["tipo"]]
                    )
                    for t in tipos:
                        tipos_encontrados.add(t)

            # Ordenar tipos para crear secciones consistentes
            # Normalización canónica y orden preferente
            def _norm_basic(s: str) -> str:
                import unicodedata

                s2 = (
                    "".join(
                        c
                        for c in unicodedata.normalize("NFD", s or "")
                        if unicodedata.category(c) != "Mn"
                    )
                    .lower()
                    .strip()
                )
                return s2

            def _tipo_canon(s: str) -> str:
                t = _norm_basic(s)
                if t.startswith("responsabilidad civil"):
                    return "responsabilidad_civil_amparo"
                mapping = {
                    "incendio": "incendio",
                    "sustraccion": "sustraccion",
                    "sustracción": "sustraccion",
                    "equipo electronico": "equipo_electronico",
                    "equipo electrónico": "equipo_electronico",
                    "rotura de maquinaria": "rotura_de_maquinaria",
                    "manejo de dinero": "manejo",
                    "manejo": "manejo",
                    "transporte de valores": "transporte_de_valores",
                }
                return mapping.get(t, t.replace(" ", "_"))

            orden_preferente = [
                "incendio",
                "sustraccion",
                "equipo_electronico",
                "rotura_de_maquinaria",
                "manejo",
                "responsabilidad_civil_amparo",
                "transporte_de_valores",
            ]

            # Mantener orden de detección original de tipos
            tipos_detectados = []
            vistos_tipos = set()
            tipo_canon_map = {}

            # Recorrer fuentes en el mismo orden de recopilación previa
            for amp in amparos_actuales["amparos"]:
                tipos = amp["tipo"] if isinstance(amp["tipo"], list) else [amp["tipo"]]
                for t in tipos:
                    if t not in vistos_tipos:
                        vistos_tipos.add(t)
                        tipos_detectados.append(t)
                    tipo_canon_map[t] = _tipo_canon(t)

            for amp in amparos_renovacion["amparos"]:
                tipos = amp["tipo"] if isinstance(amp["tipo"], list) else [amp["tipo"]]
                for t in tipos:
                    if t not in vistos_tipos:
                        vistos_tipos.add(t)
                        tipos_detectados.append(t)
                    tipo_canon_map[t] = _tipo_canon(t)

            for doc in amparos_adicionales:
                for amp in doc["amparos"]:
                    tipos = (
                        amp["tipo"] if isinstance(amp["tipo"], list) else [amp["tipo"]]
                    )
                    for t in tipos:
                        if t not in vistos_tipos:
                            vistos_tipos.add(t)
                            tipos_detectados.append(t)
                        tipo_canon_map[t] = _tipo_canon(t)

            # Construir lista ordenada por la preferencia indicada
            tipos_ordenados = []
            for canon in orden_preferente:
                for t in tipos_detectados:
                    if tipo_canon_map.get(t) == canon and t not in tipos_ordenados:
                        tipos_ordenados.append(t)
            # Agregar cualquier tipo restante no contemplado en la preferencia
            for t in tipos_detectados:
                if t not in tipos_ordenados:
                    tipos_ordenados.append(t)

            # Crear estructura basada en la imagen de referencia
            amparos_unicos = []
            amparos_vistos = set()

            # Recopilar todos los amparos únicos
            for amp in amparos_actuales["amparos"]:
                if amp["amparo"] not in amparos_vistos:
                    amparos_unicos.append(amp)
                    amparos_vistos.add(amp["amparo"])

            for amp in amparos_renovacion["amparos"]:
                if amp["amparo"] not in amparos_vistos:
                    amparos_unicos.append(amp)
                    amparos_vistos.add(amp["amparo"])

            for doc in amparos_adicionales:
                for amp in doc["amparos"]:
                    if amp["amparo"] not in amparos_vistos:
                        amparos_unicos.append(amp)
                        amparos_vistos.add(amp["amparo"])

            # Organizar por tipo (cada amparo puede pertenecer a múltiples tipos)
            amparos_por_tipo = {}
            for amp in amparos_unicos:
                tipos_amp = (
                    amp["tipo"] if isinstance(amp["tipo"], list) else [amp["tipo"]]
                )
                for t in tipos_amp:
                    amparos_por_tipo.setdefault(t, []).append(amp)

            def _normalize(text: str) -> str:
                """Convierte a minúsculas y elimina acentos/espacios extra para comparar strings."""
                if not text:
                    return ""
                return (
                    "".join(
                        c
                        for c in unicodedata.normalize("NFD", text)
                        if unicodedata.category(c) != "Mn"
                    )
                    .lower()
                    .strip()
                )

            def _consolidar_deducibles(lista_amparos, nombre_amparo: str) -> str:
                """
                Une deducibles de amparos duplicados del mismo nombre (ignorando tildes y mayúsculas),
                sin repetir valores, conservando el orden original.
                """
                vals = [
                    (a.get("deducible") or "").strip()
                    for a in lista_amparos
                    if isinstance(a, dict)
                    and (
                        a.get("amparo") == nombre_amparo
                        or _normalize(a.get("amparo")) == _normalize(nombre_amparo)
                    )
                ]

                # Eliminar deducibles vacíos
                vals = [v for v in vals if v]

                # Quitar duplicados manteniendo orden
                seen, uniq = set(), []
                for v in vals:
                    if v not in seen:
                        seen.add(v)
                        uniq.append(v)

                return "\n".join(uniq)

            def _consolidar_deducibles_doc(doc: dict, nombre_amparo: str) -> str:
                """Une deducibles de un documento adicional para un amparo, sin repetir."""
                vals = [
                    (a.get("deducible") or "").strip()
                    for a in doc.get("amparos", [])
                    if a.get("amparo") == nombre_amparo
                ]
                vals = [v for v in vals if v]
                seen = set()
                uniq = []
                for v in vals:
                    if v not in seen:
                        seen.add(v)
                        uniq.append(v)
                return "\n".join(uniq)

            # Crear estructura de datos para Excel
            for tipo in tipos_ordenados:
                # Añadir fila de sección (encabezado del tipo)
                datos_amparos.append(
                    {
                        "RAMO": tipo.upper(),
                        "CONDICIONES ACTUALES": "",
                        "ZURICH": "",
                        "AXA": "",
                        "BBVA": "",
                        "_es_seccion": True,
                    }
                )

                # Añadir amparos de este tipo
                if tipo in amparos_por_tipo:
                    for amp in amparos_por_tipo[tipo]:
                        # Consolidar deducibles en actuales, renovación y por cada adicional
                        ded_actual = _consolidar_deducibles(
                            amparos_actuales.get("amparos", []), amp["amparo"]
                        )
                        ded_renovacion = _consolidar_deducibles(
                            amparos_renovacion.get("amparos", []), amp["amparo"]
                        )
                        datos_amparos.append(
                            {
                                "RAMO": amp["amparo"],
                                "CONDICIONES ACTUALES": ded_actual,
                                "CONDICIONES DE RENOVACIÓN": ded_renovacion,
                                **{
                                    doc.get("archivo", ""): _consolidar_deducibles_doc(
                                        doc, amp["amparo"]
                                    )
                                    for doc in amparos_adicionales
                                },
                                "_es_seccion": False,
                            }
                        )

            print(f"amparos_por_tipo: {amparos_por_tipo}")

            # Crear DataFrame
            # Columnas dinámicas: RAMO, actuales, renovación y un campo por cada archivo adicional
            columnas = [
                "RAMO",
                "CONDICIONES ACTUALES",
                "CONDICIONES DE RENOVACIÓN",
            ] + [doc["archivo"] for doc in amparos_adicionales]
            df_amparos = pd.DataFrame(datos_amparos)[columnas]

            # Escribir a Excel
            df_amparos.to_excel(writer, sheet_name="Amparos", index=False)
            ws = writer.sheets["Amparos"]

            # Formateo especial para la hoja de amparos

            # 1. Insertar filas de título y preparar cabeceras multinivel
            ws.insert_rows(1, 2)

            # 2. Título principal
            title_cell = ws.cell(row=1, column=1)
            title_cell.value = titulo_excel if titulo_excel else "DEDUCIBLES"
            title_cell.font = Font(name="Calibri", size=16, bold=True, color="FFFFFF")
            title_cell.fill = PatternFill(
                start_color="1F4E78", end_color="1F4E78", fill_type="solid"
            )
            title_cell.alignment = Alignment(horizontal="center", vertical="center")
            ws.merge_cells(
                start_row=1, start_column=1, end_row=1, end_column=len(columnas)
            )

            # 3. Encabezados de grupo (fila 2) y subencabezados (fila 3)
            # RAMO ocupa dos filas
            ws.merge_cells(start_row=2, start_column=1, end_row=3, end_column=1)
            a2 = ws.cell(row=2, column=1)
            a2.value = "RAMO"
            a2.font = Font(name="Calibri", size=11, bold=True, color="FFFFFF")
            a2.fill = PatternFill(
                start_color="1F4E78", end_color="1F4E78", fill_type="solid"
            )
            a2.alignment = Alignment(
                horizontal="center", vertical="center", wrap_text=True
            )
            a2.border = Border(
                left=Side(style="thin", color="000000"),
                right=Side(style="thin", color="000000"),
                top=Side(style="thin", color="000000"),
                bottom=Side(style="thin", color="000000"),
            )

            # CONDICIONES ACTUALES (columna B) con subencabezado dinámico del archivo de actuales
            b2 = ws.cell(row=2, column=2)
            b2.value = "CONDICIONES ACTUALES"
            b2.font = Font(name="Calibri", size=11, bold=True, color="FFFFFF")
            b2.fill = PatternFill(
                start_color="1F4E78", end_color="1F4E78", fill_type="solid"
            )
            b2.alignment = Alignment(
                horizontal="center", vertical="center", wrap_text=True
            )
            b2.border = Border(
                left=Side(style="thin", color="000000"),
                right=Side(style="thin", color="000000"),
                top=Side(style="thin", color="000000"),
                bottom=Side(style="thin", color="000000"),
            )
            ws.cell(row=3, column=2).value = amparos_actuales.get(
                "archivo", "CONDICIONES ACTUALES"
            )

            # CONDICIONES DE RENOVACIÓN (columna C)
            c2 = ws.cell(row=2, column=3)
            c2.value = "CONDICIONES DE RENOVACIÓN"
            c2.font = Font(name="Calibri", size=11, bold=True, color="FFFFFF")
            c2.fill = PatternFill(
                start_color="1F4E78", end_color="1F4E78", fill_type="solid"
            )
            c2.alignment = Alignment(
                horizontal="center", vertical="center", wrap_text=True
            )
            c2.border = Border(
                left=Side(style="thin", color="000000"),
                right=Side(style="thin", color="000000"),
                top=Side(style="thin", color="000000"),
                bottom=Side(style="thin", color="000000"),
            )
            ws.cell(row=3, column=3).value = amparos_renovacion.get(
                "archivo", "CONDICIONES DE RENOVACIÓN"
            )

            # COTIZACIONES adicionales (desde la columna 4 en adelante)
            if len(columnas) > 3:
                ws.merge_cells(
                    start_row=2, start_column=4, end_row=2, end_column=len(columnas)
                )
                d2 = ws.cell(row=2, column=4)
                d2.value = "ARCHIVOS ADICIONALES"
                d2.font = Font(name="Calibri", size=11, bold=True, color="FFFFFF")
                d2.fill = PatternFill(
                    start_color="1F4E78", end_color="1F4E78", fill_type="solid"
                )
                d2.alignment = Alignment(
                    horizontal="center", vertical="center", wrap_text=True
                )
                d2.border = Border(
                    left=Side(style="thin", color="000000"),
                    right=Side(style="thin", color="000000"),
                    top=Side(style="thin", color="000000"),
                    bottom=Side(style="thin", color="000000"),
                )
                # Subencabezados con nombres reales de archivos
                for idx, nombre_archivo in enumerate(columnas[3:], start=4):
                    ws.cell(row=3, column=idx).value = nombre_archivo

            # 4. Formatear subencabezados de columna (fila 3)
            for col_num in range(1, len(columnas) + 1):
                cell = ws.cell(row=3, column=col_num)
                cell.font = Font(name="Calibri", size=11, bold=True, color="FFFFFF")
                fill_map = {
                    1: "1F4E78",  # RAMO
                    2: "1F4E78",  # Actual
                    3: "1F4E78",  # Renovación
                }
                color = fill_map.get(col_num, "1F4E78")
                cell.fill = PatternFill(
                    start_color=color, end_color=color, fill_type="solid"
                )
                cell.border = Border(
                    left=Side(style="thin", color="000000"),
                    right=Side(style="thin", color="000000"),
                    top=Side(style="thin", color="000000"),
                    bottom=Side(style="thin", color="000000"),
                )
                cell.alignment = Alignment(
                    horizontal="center", vertical="center", wrap_text=True
                )

            # 4. Formatear datos
            for row_num in range(4, len(df_amparos) + 4):
                fila_datos = datos_amparos[row_num - 4]
                es_seccion = fila_datos.get("_es_seccion", False)

                for col_num in range(1, len(columnas) + 1):
                    cell = ws.cell(row=row_num, column=col_num)

                    if es_seccion:
                        # Formato para filas de sección (tipo de amparo)
                        cell.font = Font(
                            name="Calibri", size=11, bold=True, color="FFFFFF"
                        )
                        cell.fill = PatternFill(
                            start_color="1F4E78", end_color="1F4E78", fill_type="solid"
                        )
                        cell.alignment = Alignment(
                            horizontal="center", vertical="center", wrap_text=True
                        )

                        # Mergear toda la fila para la sección
                        if col_num == 1:
                            ws.merge_cells(
                                start_row=row_num,
                                start_column=1,
                                end_row=row_num,
                                end_column=len(columnas),
                            )
                    else:
                        # Formato para filas de datos normales
                        cell.font = Font(name="Calibri", size=10)
                        cell.alignment = Alignment(
                            horizontal="left", vertical="center", wrap_text=True
                        )

                    # Bordes para todas las celdas
                    cell.border = Border(
                        left=Side(style="thin", color="000000"),
                        right=Side(style="thin", color="000000"),
                        top=Side(style="thin", color="000000"),
                        bottom=Side(style="thin", color="000000"),
                    )

            # 5. Ajustar anchos de columna
            ws.column_dimensions["A"].width = 50  # RAMO - más ancho para nombres largos
            ws.column_dimensions["B"].width = 30  # CONDICIONES ACTUALES
            ws.column_dimensions["C"].width = 30  # ZURICH
            ws.column_dimensions["D"].width = 30  # AXA
            ws.column_dimensions["E"].width = 30  # BBVA

            # 6. Ajustar altura de filas para mejor legibilidad
            for row_num in range(1, len(df_amparos) + 4):
                ws.row_dimensions[row_num].height = 20

        # Nota: la hoja de Amparos se generará después de Riesgos para priorizar su orden

        # ===== hoja Riesgos (cuarta hoja) =====
        def crear_hoja_riesgos():
            # 1) Normalización de intereses asegurados (para consistencia)
            def normalizar_interes(texto: str) -> str:
                t = (texto or "").strip().lower()
                reemplazos = {
                    "edificio": "Edificio",
                    "muebles y enseres": "Muebles y Enseres",
                    "maquinaria y equipo": "Maquinaria y Equipo",
                    "equipo electrico y electronico": "Equipo Eléctrico y Electrónico",
                    "equipo eléctrico y electrónico": "Equipo Eléctrico y Electrónico",
                    "mercancías": "Mercancías",
                    "mercancias": "Mercancías",
                    "dineros": "Dineros",
                    "equipo movil": "Equipo Móvil",
                    "equipo móvil": "Equipo Móvil",
                    "obras de arte": "Obras de Arte",
                    # Mantener subcategorías distintas de RC
                    "responsabilidad civil extracontractual": "Responsabilidad Civil Extracontractual",
                    "responsabilidad civil directores y administradores": "Responsabilidad Civil Directores y Administradores",
                }
                # caso combinado en renovación
                if "+" in t and "muebles" in t and "obras" in t:
                    return "Muebles y Enseres"  # asignamos al rubro principal

                # No colapsar subtipos de RC en una sola categoría; usar reemplazos arriba

                return reemplazos.get(t, texto)

            # 2) Definir columnas a partir de riesgos_actuales (L36-375)
            intereses_cols = sorted(
                {
                    normalizar_interes(det["interes_asegurado"])  # noqa: E501
                    for r in riesgos_actuales
                    for det in r.get("detalle_cobertura", [])
                }
            )

            def pivot_riesgos(dataset):
                # Agregar por ubicación para evitar filas duplicadas
                agregados = {}
                for r in dataset:
                    ubic = r.get("ubicacion", "")
                    if ubic not in agregados:
                        agregados[ubic] = {col: 0 for col in intereses_cols}
                    for det in r.get("detalle_cobertura", []):
                        k = normalizar_interes(det.get("interes_asegurado", ""))
                        if k in agregados[ubic]:
                            valor_asegurado = det.get("valor_asegurado", 0)
                            agregados[ubic][k] += valor_asegurado

                filas = []
                for ubic, valores in agregados.items():
                    fila = {"Ubicación": ubic}
                    fila.update(valores)
                    filas.append(fila)

                # Totales
                tot = {"Ubicación": "TOTAL VALORES"}
                for col in intereses_cols:
                    tot[col] = sum(f[col] for f in filas)
                filas.append(tot)
                return pd.DataFrame(filas, columns=["Ubicación"] + intereses_cols)

            out_dir = pathlib.Path(__file__).parent / "riesgos_json"
            out_dir.mkdir(exist_ok=True)

            df_actual = pivot_riesgos(riesgos_actuales)
            df_renov = pivot_riesgos(riesgos_renovacion)

            # Escribir ambas tablas en la MISMA hoja, con los mismos encabezados
            # Reservamos la fila 1 para un título general de la hoja
            start_row = 1
            sheet_name = "Riesgos"

            # Tabla 1: Póliza actual
            df_actual.to_excel(
                writer, sheet_name=sheet_name, index=False, startrow=start_row + 1
            )
            ws = writer.sheets[sheet_name]

            # Título principal de la hoja Riesgos (fila 1)
            riesgos_title_cell = ws.cell(row=1, column=1)
            riesgos_title_cell.value = titulo_excel if titulo_excel else "RIESGOS"
            riesgos_title_cell.font = Font(
                name="Calibri", size=16, bold=True, color="FFFFFF"
            )
            riesgos_title_cell.fill = PatternFill(
                start_color="1F4E78", end_color="1F4E78", fill_type="solid"
            )
            riesgos_title_cell.alignment = Alignment(
                horizontal="center", vertical="center"
            )
            ws.merge_cells(
                start_row=1,
                start_column=1,
                end_row=1,
                end_column=len(df_actual.columns),
            )
            ws.cell(row=start_row + 1, column=1, value="Póliza actual").font = Font(
                name="Arial", size=13, bold=True
            )
            ws.merge_cells(
                start_row=start_row + 1,
                start_column=1,
                end_row=start_row + 1,
                end_column=len(df_actual.columns),
            )

            # Formato encabezados y celdas de la primera tabla
            header_row_1 = start_row + 2
            for col_idx in range(1, len(df_actual.columns) + 1):
                c = ws.cell(row=header_row_1, column=col_idx)
                c.font = header_font
                c.fill = header_fill
                c.border = border
                c.alignment = center_alignment
            for r in range(header_row_1 + 1, header_row_1 + 1 + len(df_actual)):
                for cidx in range(1, len(df_actual.columns) + 1):
                    c = ws.cell(row=r, column=cidx)
                    c.font = data_font
                    c.border = border
                    if cidx == 1:
                        c.alignment = left_alignment
                    else:
                        c.alignment = currency_alignment
                        if isinstance(c.value, (int, float)):
                            c.number_format = "$#,##0"

            # Tabla 2: Póliza de Renovación
            start_row_2 = header_row_1 + len(df_actual) + 2
            df_renov.to_excel(
                writer, sheet_name=sheet_name, index=False, startrow=start_row_2 + 1
            )
            ws.cell(
                row=start_row_2 + 1, column=1, value="Póliza de Renovación"
            ).font = Font(name="Arial", size=13, bold=True)
            ws.merge_cells(
                start_row=start_row_2 + 1,
                start_column=1,
                end_row=start_row_2 + 1,
                end_column=len(df_renov.columns),
            )

            header_row_2 = start_row_2 + 2
            for col_idx in range(1, len(df_renov.columns) + 1):
                c = ws.cell(row=header_row_2, column=col_idx)
                c.font = header_font
                c.fill = header_fill
                c.border = border
                c.alignment = center_alignment
            for r in range(header_row_2 + 1, header_row_2 + 1 + len(df_renov)):
                for cidx in range(1, len(df_renov.columns) + 1):
                    c = ws.cell(row=r, column=cidx)
                    c.font = data_font
                    c.border = border
                    if cidx == 1:
                        c.alignment = left_alignment
                    else:
                        c.alignment = currency_alignment
                        if isinstance(c.value, (int, float)):
                            c.number_format = "$#,##0"

            # Ajuste de anchos para toda la hoja
            for cidx in range(1, len(df_actual.columns) + 1):
                letter = get_column_letter(cidx)
                if cidx == 1:
                    ws.column_dimensions[letter].width = 50
                else:
                    ws.column_dimensions[letter].width = 20

        crear_hoja_riesgos()

        # Generar hoja de Amparos después de Riesgos para que aparezca luego en el libro
        crear_hoja_amparos()

    with open(output_path, "wb") as f:
        f.write(output.getvalue())

    print(f"✅ Archivo Excel generado exitosamente: {output_path}")
    return output_path


if __name__ == "__main__":
    generar_excel_analisis_polizas(
        riesgos_actuales=riesgos_actuales,
        riesgos_renovacion=riesgos_renovacion,
        amparos_actuales=amparos_actuales,
        amparos_renovacion=amparos_renovacion,
        amparos_adicionales=amparos_adicionales,
        output_path="poliza_analisis.xlsx",
        titulo_excel="MESSIIIIIII",
    )
